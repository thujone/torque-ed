# DOMAIN_MODEL.md - Business Logic & Rules

## Overview

This document defines the business rules, domain logic, and terminology used throughout TorqueEd. It serves as the authoritative source for understanding how the automotive education domain is modeled in the system.

## Core Concepts

### Educational Hierarchy

```
School System
    └── Schools
            └── Courses
                    └── Classes (instances of courses per semester)
                            └── Students (via Enrollments)
```

### Time-Based Concepts

- **Academic Year**: Typically consists of Fall, Spring, and Summer semesters
- **Semester**: A discrete time period containing classes (e.g., "Fall 2025")
- **Class Session**: A single scheduled session of a class (renamed from Class Meeting)
- **Holiday**: Days when no classes meet (blocks session generation)
- **Midterm Period**: Date range for midterm exams (only last session in range marked as midterm)
- **Final Period**: Date range for final exams (only last session in range marked as final)

## Business Rules

### User Management Rules

#### Role Hierarchy
1. **Super Admin**
   - Can perform any action in the system
   - Typically IT staff or system administrators
   - Limited to 2-3 users per school system
   - Displayed in "Administrators" section of admin UI

2. **Admin**
   - Manages schools, courses, and semesters
   - Can create instructor accounts
   - Usually department heads
   - Cannot modify super admin accounts
   - Displayed in "Administrators" section of admin UI

3. **Instructor**
   - Manages their assigned classes
   - Can add/drop students with notification
   - Can cancel individual class meetings
   - Cannot create courses or modify semester dates
   - Displayed in "Instructors" section of admin UI

4. **Teaching Assistant**
   - Can mark attendance
   - Read-only access to class rosters
   - Cannot modify enrollments
   - Future: Can enter grades under instructor supervision
   - Displayed in "Instructors" section of admin UI (grouped with instructors for simplicity)

#### Multi-Role Rules
- Users can have different roles in different contexts
- A person can be a TA in one class while enrolled as a student in another
- Role conflicts are resolved by most restrictive access
- Instructors cannot be students in their own classes

### Enrollment Management

#### Enrollment States
```
Waitlisted → Enrolled → Dropped
    ↓           ↓
    └───────────┘
```

#### Enrollment Rules
1. **Capacity Management**
   - Classes have a maximum enrollment limit
   - When full, new enrollments go to waitlist
   - Waitlist maintains FIFO order
   - Dropping a student may auto-promote from waitlist

2. **Add/Drop Rules**
   - Students can be added until 2 weeks after semester start
   - Drops are allowed until 60% through the semester
   - Late adds require admin approval
   - Dropped students retain historical attendance records

3. **Waitlist Management**
   - Waitlist position is strictly ordered
   - Students cannot skip positions
   - Instructor can override waitlist order with admin notification
   - Waitlist clears at semester end

### Attendance Tracking

#### Attendance States
- **Present**: Student has clocked in (clockInTime recorded)
- **Absent**: No clock-in recorded (default)
- **Excused**: Absence marked as excused by instructor/admin

#### Clock-In/Clock-Out System
1. **Smart Scanner Logic**
   - **First scan**: Creates attendance record with clockInTime
   - **Second scan**: Updates record with clockOutTime
   - **Duration**: Automatically calculated in minutes when both times present
   - **Manual Override**: All three fields (clock in, out, duration) can be edited manually

2. **Attendance Rules**
   - Can only clock in for scheduled sessions
   - Past attendance can be edited up to 30 days
   - Future attendance cannot be marked
   - Smart scanner detects existing records to determine clock-in vs clock-out

3. **QR Code Rules**
   - Each student has one permanent QR code
   - QR codes are UUIDs for security
   - Lost QR codes can be regenerated by admin
   - QR codes work across all enrolled classes
   - Scanner automatically finds today's sessions for the student

4. **Session Duration Tracking**
   - Duration calculated as clockOutTime - clockInTime in minutes
   - Displayed in human-readable format (e.g., "1h 30m", "45m")
   - Teachers/TAs can manually adjust if needed
   - Duration updates automatically when times are changed

### Scheduling Rules

#### Class Session Generation
1. **Recurrence Patterns**
   - Simple weekly patterns only (MWF, TTh, etc.)
   - No bi-weekly or monthly patterns in Phase A
   - Sessions generated for entire semester at class creation
   - Each session includes courseNumber and dayOfWeek fields

2. **Holiday Handling**
   - Holidays block session generation automatically
   - Sessions are never created on holiday dates
   - Holiday changes don't affect existing sessions

3. **Midterm/Final Session Marking**
   - Only the LAST session in midterm date range is marked as "midterm"
   - Only the LAST session in final date range is marked as "final"
   - All other sessions remain "regular" type
   - Prevents multiple midterm/final sessions per class

4. **Session Modifications**
   - Individual sessions can be cancelled
   - Cancelled sessions cannot be restored
   - Start time changes auto-calculate end time based on class duration
   - End time is read-only (calculated from start time + class duration)
   - Room changes can be per-session or permanent

#### Schedule Validation
- Classes cannot overlap in the same room
- Instructor cannot have overlapping classes
- Minimum 15 minutes between back-to-back classes
- Maximum 4 hours per class meeting

### Course Management

#### Course Rules
1. **Course Codes**
   - Must follow pattern: DEPT-### (e.g., AUTO-302)
   - Codes are unique within school system
   - Cannot change code after classes exist

2. **Course Sharing**
   - Courses can be shared across schools in system
   - Changes to course affect all schools
   - Schools can override course descriptions locally

3. **Prerequisites**
   - Stored as free text in Phase A
   - Not enforced by system
   - For informational purposes only

### Data Validation Rules

#### Required Fields
- All person names (first and last)
- Email addresses (must be valid format)
- Course codes and names
- Class section identifiers
- Semester dates
- Meeting schedules

#### Unique Constraints
- Email addresses (system-wide)
- Student IDs (system-wide)
- QR codes (system-wide)
- Course codes (per school system)
- Class sections (per course per semester)

#### Date/Time Rules
- Semester end date must be after start date
- Midterm period within semester dates
- Final period after midterm period
- Class meetings within semester dates
- Historical dates cannot be modified

### Notification Rules

#### Mandatory Notifications
1. **Enrollment Changes**
   - Student added: → Instructor, Admin
   - Student dropped: → Instructor, Admin, Student
   - Waitlist promotion: → Student

2. **Schedule Changes**
   - Meeting cancelled: → All enrolled students
   - Time/room change: → All enrolled students
   - Instructor change: → All enrolled students

#### Notification Delivery
- Email is primary channel
- Sent asynchronously
- Failures logged but don't block operations
- No delivery confirmation required

### Security & Privacy Rules

#### FERPA Compliance
1. **Data Access**
   - Students can only see their own records (future)
   - Instructors see only their class rosters
   - TAs have read-only access to attendance
   - Cross-class data requires admin role

2. **Data Retention**
   - Attendance records kept indefinitely
   - Dropped student data retained
   - Audit logs kept for 7 years
   - PII deletion by request only

#### Multi-Tenant Isolation
- No data sharing between school systems
- Separate subdomains per system (future)
- User accounts scoped to school system
- No global super admin role

### Business Logic Flows

#### Student Enrollment Flow
```
1. Admin/Instructor initiates add
2. Check enrollment capacity
3. If full → Add to waitlist
4. If space → Create enrollment
5. Send notifications
6. Update attendance grid
```

#### Attendance Clock-In/Clock-Out Flow
```
1. QR scanned → Extract student identifier
2. Verify student enrolled in classes
3. Find today's scheduled sessions for student
4. Check existing attendance records:
   - No record: Create with clockInTime (CLOCK IN)
   - Has clockInTime only: Update with clockOutTime (CLOCK OUT)
   - Has both times: Show "already completed" message
5. Auto-calculate session duration if both times present
6. Update UI optimistically with real-time feedback
7. Allow manual editing of all fields by teachers/TAs
```

#### Semester Setup Flow
```
1. Admin creates semester with dates
2. Define holidays and break periods
3. Create courses or reuse existing
4. Create class sections with schedules
5. System automatically generates all sessions (excluding holidays)
6. Only last session in midterm/final periods marked appropriately
7. Assign instructors and TAs
8. Open for enrollment
```

### Reporting Rules

#### Attendance Reports
- Percentage calculated as Present/(Present+Absent)
- Excused absences don't count against percentage
- Minimum 70% attendance for passing (configurable)
- Reports exportable as CSV

#### Enrollment Reports
- Current enrollment vs capacity
- Waitlist lengths
- Drop rates by class
- Historical trends by semester

### Worksheets & Utilities

#### Attendance Sheets
The system provides a custom spreadsheet-style interface for managing attendance:

1. **Access**: Available under "Worksheets" → "Attendance Sheets" in admin navigation
2. **View**: Located at `/attendance` URL in the admin interface
3. **Functionality**:
   - Grid layout showing students vs. class sessions
   - Three columns per session: Clock In, Clock Out, Duration
   - Smart QR scanner integration for real-time attendance marking
   - Export capabilities for external processing
   - Filtering by class, date range, and attendance status

4. **User Permissions**:
   - Instructors: Can view and edit attendance for their assigned classes
   - Teaching Assistants: Can mark attendance for assigned classes
   - Administrators: Can view all attendance data
   - Super Admins: Full access to all attendance functions

5. **Data Display**:
   - Student names sorted alphabetically by last name, first name
   - Session dates chronologically ordered
   - Visual indicators for present/absent/excused status
   - Duration calculations automatically updated

### Future Phase Considerations

#### Phase B (Grading)
- Grades attached to enrollments
- Multiple grade types (assignments, exams)
- Weighted grade calculations
- Grade submission deadlines

#### Phase C (Coursework)
- Competency-based progression
- Video submission requirements
- Skill verification workflows
- Industry certification tracking

## Glossary

- **Class**: A specific instance of a course in a semester (e.g., "AUTO-302 Morning Section")
- **Class Session**: A single scheduled meeting of a class (renamed from "Class Meeting")
- **Clock-In Time**: Timestamp when student arrived and scanned QR code
- **Clock-Out Time**: Timestamp when student left and scanned QR code again
- **Course**: A curriculum unit with specific learning objectives (e.g., "AUTO-302 Transmission Repair")
- **Course Number**: The course code (e.g., "AUTO-302") displayed in session lists
- **Day of Week**: Auto-generated field showing the day name (e.g., "Monday", "Wednesday")
- **Enrollment**: A student's registration in a specific class
- **QR Code**: Quick Response code used for student identification and smart clock-in/out
- **School System**: A collection of related schools (e.g., a community college district)
- **Section**: An identifier for different instances of the same course
- **Semester**: An academic term (Fall, Spring, Summer)
- **Session Duration**: Auto-calculated time between clock-in and clock-out in minutes
- **TA**: Teaching Assistant
- **Waitlist**: Ordered queue of students waiting for enrollment space