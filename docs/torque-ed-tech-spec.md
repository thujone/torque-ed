# Technical Specification
# TorqueEd (Automotive Education CMS)

**Version:** 1.0  
**Date:** July 3, 2025  
**Author:** Rich Goldman (rich@comfypants.org)  
**Status:** Draft

## 1. Overview

This document provides the technical specification for TorqueEd Phase A, built on KeystoneJS 6. The system implements a multi-tenant automotive education management platform with QR-based attendance tracking.

## 2. Technology Stack

### Core Technologies
- **Runtime:** Node.js 20.x LTS with TypeScript
- **CMS Framework:** KeystoneJS 6
- **Database:** PostgreSQL 15+
- **ORM:** Prisma (via KeystoneJS)
- **API:** GraphQL (auto-generated by KeystoneJS)
- **Frontend:** React 18 (KeystoneJS Admin UI)
- **Package Manager:** Yarn
- **Authentication:** KeystoneJS Auth (session-based)

### Development Tools
- **TypeScript:** 5.x
- **Linting:** ESLint with TypeScript rules
- **Testing:** Jest for unit tests, Playwright for E2E
- **Version Control:** Git
- **CI/CD:** GitHub Actions

### Deployment Stack
- **Container:** Docker
- **Orchestration:** Kubernetes (future)
- **Cloud Provider:** AWS (primary) / DigitalOcean (alternative)
- **Database Hosting:** AWS RDS or managed PostgreSQL
- **File Storage:** AWS S3 for backups and exports

## 3. Architecture

### System Architecture

```
┌─────────────────────┐     ┌──────────────────┐
│   QR Scanner        │────▶│                  │
│   (HID Device)      │     │                  │
└─────────────────────┘     │                  │
                            │   KeystoneJS     │
┌─────────────────────┐     │   Application    │     ┌─────────────────┐
│   Browser           │────▶│                  │────▶│   PostgreSQL    │
│   (Admin UI)        │     │  - GraphQL API   │     │   Database      │
└─────────────────────┘     │  - Admin UI      │     └─────────────────┘
                            │  - Custom Pages   │
                            │                  │
                            └──────────────────┘
```

### Multi-Tenant Architecture

Each school system is logically isolated through:
- Tenant ID on all records
- Row-level security via KeystoneJS access control
- Separate schemas per tenant (future consideration)

## 4. Data Models

### Core Entities

#### SchoolSystem
```typescript
{
  id: ID
  name: String (required, unique)
  subdomain: String (unique) // for future multi-tenant URLs
  settings: JSON // system-wide configuration
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### School
```typescript
{
  id: ID
  name: String (required)
  schoolSystem: Relationship(SchoolSystem)
  address: String
  administrators: Relationship(User, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### User
```typescript
{
  id: ID
  email: String (required, unique)
  password: Password
  firstName: String (required)
  lastName: String (required)
  roles: Select (multi) ['superAdmin', 'admin', 'instructor', 'ta']
  schoolSystem: Relationship(SchoolSystem)
  schools: Relationship(School, many) // for admins
  instructorClasses: Relationship(Class, many)
  taClasses: Relationship(Class, many)
  studentEnrollments: Relationship(Enrollment, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Course
```typescript
{
  id: ID
  code: String (required) // e.g., "AUTO-302"
  name: String (required) // e.g., "Transmission Repair"
  description: Text
  prerequisites: String // free text for now
  schoolSystem: Relationship(SchoolSystem)
  classes: Relationship(Class, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Semester
```typescript
{
  id: ID
  name: String (required) // e.g., "Fall 2025"
  schoolSystem: Relationship(SchoolSystem)
  startDate: DateTime (required)
  endDate: DateTime (required)
  midtermStartDate: DateTime
  midtermEndDate: DateTime
  finalStartDate: DateTime
  finalEndDate: DateTime
  holidays: Relationship(Holiday, many)
  classes: Relationship(Class, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Holiday
```typescript
{
  id: ID
  name: String (required)
  date: DateTime (required)
  semester: Relationship(Semester)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Class
```typescript
{
  id: ID
  section: String (required) // e.g., "Morning II"
  course: Relationship(Course)
  semester: Relationship(Semester)
  school: Relationship(School)
  instructor: Relationship(User)
  teachingAssistants: Relationship(User, many)
  maxEnrollment: Integer (required)
  room: String
  schedule: JSON // { days: ['M','W','F'], startTime: '08:00', endTime: '09:30' }
  enrollments: Relationship(Enrollment, many)
  meetings: Relationship(ClassMeeting, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Student
```typescript
{
  id: ID
  studentId: String (required, unique)
  firstName: String (required)
  lastName: String (required)
  email: String (required)
  qrCode: String (required, unique) // UUID
  schoolSystem: Relationship(SchoolSystem)
  enrollments: Relationship(Enrollment, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Enrollment
```typescript
{
  id: ID
  student: Relationship(Student)
  class: Relationship(Class)
  status: Select ['enrolled', 'waitlisted', 'dropped']
  waitlistPosition: Integer // null if enrolled
  enrolledAt: DateTime
  droppedAt: DateTime
  attendanceRecords: Relationship(AttendanceRecord, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### ClassMeeting
```typescript
{
  id: ID
  class: Relationship(Class)
  scheduledDate: DateTime (required)
  scheduledStartTime: String (required)
  scheduledEndTime: String (required)
  actualDate: DateTime // if rescheduled
  status: Select ['scheduled', 'completed', 'cancelled']
  isMidterm: Boolean (default: false)
  isFinal: Boolean (default: false)
  room: String // can override class default
  attendanceRecords: Relationship(AttendanceRecord, many)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### AttendanceRecord
```typescript
{
  id: ID
  enrollment: Relationship(Enrollment)
  classMeeting: Relationship(ClassMeeting)
  status: Select ['present', 'absent', 'excused']
  markedAt: DateTime
  markedBy: Relationship(User)
  notes: Text
  createdAt: DateTime
  updatedAt: DateTime
}
```

### Access Control Rules

```typescript
// Example access control for Class
access: {
  operation: {
    create: ({ session }) => 
      session?.data.roles.includes('admin') || 
      session?.data.roles.includes('superAdmin'),
    update: ({ session, item }) => 
      session?.data.roles.includes('admin') || 
      session?.data.id === item.instructorId,
    delete: ({ session }) => 
      session?.data.roles.includes('superAdmin')
  },
  filter: {
    query: ({ session }) => {
      if (session?.data.roles.includes('superAdmin')) return true;
      if (session?.data.roles.includes('admin')) {
        return { school: { administrators: { some: { id: { equals: session.data.id } } } } };
      }
      if (session?.data.roles.includes('instructor')) {
        return { instructor: { id: { equals: session.data.id } } };
      }
      if (session?.data.roles.includes('ta')) {
        return { teachingAssistants: { some: { id: { equals: session.data.id } } } };
      }
      return false;
    }
  }
}
```

## 5. Key Features Implementation

### QR Code Attendance System

#### QR Code Generation
- Generate UUID v4 for each student
- Store as plain text in database
- Frontend displays as QR code using `qrcode` library

#### Scanner Integration
```typescript
// Custom page component for attendance
const AttendanceScanner = () => {
  const [scannedCode, setScannedCode] = useState('');
  
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === 'Enter' && scannedCode) {
        processAttendance(scannedCode);
        setScannedCode('');
      } else if (e.key.length === 1) {
        setScannedCode(prev => prev + e.key);
      }
    };
    
    window.addEventListener('keypress', handleKeyPress);
    return () => window.removeEventListener('keypress', handleKeyPress);
  }, [scannedCode]);
  
  // ... rest of component
};
```

### Class Meeting Generation

```typescript
// Algorithm for generating meetings
function generateClassMeetings(class: Class, semester: Semester, holidays: Holiday[]) {
  const meetings: ClassMeeting[] = [];
  const { days, startTime, endTime } = class.schedule;
  
  let currentDate = new Date(semester.startDate);
  const endDate = new Date(semester.endDate);
  
  while (currentDate <= endDate) {
    const dayOfWeek = currentDate.getDay();
    const dayLetter = ['S','M','T','W','T','F','S'][dayOfWeek];
    
    if (days.includes(dayLetter)) {
      const isHoliday = holidays.some(h => 
        isSameDay(new Date(h.date), currentDate)
      );
      
      if (!isHoliday) {
        meetings.push({
          class: class.id,
          scheduledDate: currentDate,
          scheduledStartTime: startTime,
          scheduledEndTime: endTime,
          status: 'scheduled',
          isMidterm: isWithinMidtermPeriod(currentDate, semester),
          isFinal: isWithinFinalPeriod(currentDate, semester)
        });
      }
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  return meetings;
}
```

### Attendance Spreadsheet View

Custom React component integrated into KeystoneJS admin:

```typescript
// Simplified attendance grid component
const AttendanceGrid = ({ classId }: { classId: string }) => {
  const { data } = useQuery(GET_ATTENDANCE_DATA, { 
    variables: { classId } 
  });
  
  return (
    <Table>
      <thead>
        <tr>
          <th>Student</th>
          {data.meetings.map(meeting => (
            <th key={meeting.id}>
              {format(meeting.scheduledDate, 'MM/dd')}
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {data.enrollments.map(enrollment => (
          <tr key={enrollment.id}>
            <td>{enrollment.student.name}</td>
            {data.meetings.map(meeting => {
              const record = findAttendanceRecord(enrollment, meeting);
              return (
                <td key={meeting.id} className={record?.status}>
                  {record?.status || '-'}
                </td>
              );
            })}
          </tr>
        ))}
      </tbody>
    </Table>
  );
};
```

## 6. API Design

### GraphQL Schema (Auto-generated by KeystoneJS)

Key queries:
```graphql
type Query {
  # Get attendance data for spreadsheet view
  class(where: ClassWhereUniqueInput!): Class
  
  # Find student by QR code
  students(where: StudentWhereInput!): [Student!]
  
  # Get today's meetings for an instructor
  classMeetings(where: ClassMeetingWhereInput!): [ClassMeeting!]
}

type Mutation {
  # Mark attendance
  createAttendanceRecord(data: AttendanceRecordCreateInput!): AttendanceRecord
  
  # Update attendance
  updateAttendanceRecord(
    where: AttendanceRecordWhereUniqueInput!
    data: AttendanceRecordUpdateInput!
  ): AttendanceRecord
  
  # Manage enrollments
  updateEnrollment(
    where: EnrollmentWhereUniqueInput!
    data: EnrollmentUpdateInput!
  ): Enrollment
}
```

### Custom API Endpoints

```typescript
// Custom REST endpoint for bulk operations
app.get('/api/export/attendance/:classId', async (req, res) => {
  // Generate CSV export
});

// Webhook for notifications
app.post('/api/webhooks/roster-change', async (req, res) => {
  // Send email notifications
});
```

## 7. Security Implementation

### Authentication & Authorization
- KeystoneJS session-based auth
- Role-based access control at field level
- Multi-tenant data isolation via access rules

### Data Protection
- HTTPS enforcement via reverse proxy
- Database encryption at rest (AWS RDS)
- Bcrypt password hashing (KeystoneJS default)
- Session tokens with secure httpOnly cookies

### FERPA Compliance
- Audit logging for all data access
- Granular permissions per role
- Data retention policies
- Export capabilities for student records

## 8. Performance Optimizations

### Database
- Indexes on frequently queried fields:
  - `Student.qrCode` (unique)
  - `Student.studentId` (unique)
  - `Enrollment.class` + `Enrollment.student` (compound)
  - `AttendanceRecord.classMeeting` + `AttendanceRecord.enrollment` (compound)

### Caching
- GraphQL query caching with DataLoader
- Static asset caching via CDN
- Database connection pooling

### Batch Operations
- Bulk attendance marking
- Batch enrollment processing
- Optimized meeting generation

## 9. Deployment Configuration

### Environment Variables
```bash
# .env.example
DATABASE_URL=postgresql://user:password@host:5432/torque-ed
SESSION_SECRET=<random-32-char-string>
PORT=3000
NODE_ENV=production
AWS_ACCESS_KEY_ID=<aws-key>
AWS_SECRET_ACCESS_KEY=<aws-secret>
AWS_REGION=us-west-2
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=<smtp-user>
SMTP_PASS=<smtp-pass>
```

### Docker Configuration
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile
COPY . .
RUN yarn build
EXPOSE 3000
CMD ["yarn", "start"]
```

### Database Migrations
- Managed by Prisma (via KeystoneJS)
- Migration files tracked in version control
- Automated migration on deployment

## 10. Testing Strategy

### Unit Tests
- Model validation logic
- Access control rules
- Meeting generation algorithm
- QR code processing

### Integration Tests
- GraphQL API endpoints
- Authentication flows
- Multi-tenant isolation

### E2E Tests
- Complete attendance workflow
- Admin setup procedures
- Roster management

## 11. Monitoring & Logging

### Application Monitoring
- Error tracking with Sentry
- Performance monitoring with New Relic
- Uptime monitoring with Pingdom

### Logging
- Structured JSON logging
- Log aggregation with CloudWatch/ELK
- Audit trail for compliance

## 12. Future Considerations

### Phase B Preparation
- Grade field preparations in data model
- API versioning strategy
- Gradebook UI component architecture

### Phase C Preparation
- MongoDB integration planning
- Video storage architecture
- Curriculum API design

### Scalability Path
- Database sharding strategy
- Kubernetes deployment manifests
- CDN integration for static assets