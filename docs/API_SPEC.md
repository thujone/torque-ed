# API_SPEC.md - API Documentation

## Overview

TorqueEd exposes a GraphQL API (auto-generated by KeystoneJS) for all data operations, plus custom REST endpoints for specialized functionality. All APIs require authentication except public health checks.

## Authentication

### Session-Based Auth
```typescript
// Login mutation
mutation login($email: String!, $password: String!) {
  authenticateUserWithPassword(email: $email, password: $password) {
    ... on UserAuthenticationWithPasswordSuccess {
      sessionToken
      item {
        id
        email
        firstName
        lastName
        roles
      }
    }
    ... on UserAuthenticationWithPasswordFailure {
      message
    }
  }
}
```

### Session Management
- Sessions stored in PostgreSQL
- 30-day expiration (configurable)
- HTTP-only secure cookies
- CSRF protection enabled

## GraphQL API

### Core Queries

#### User Queries
```graphql
# Get current user
query currentUser {
  authenticatedItem {
    ... on User {
      id
      email
      firstName
      lastName
      roles
      schoolSystem {
        id
        name
      }
    }
  }
}

# List users with filtering
query listUsers($where: UserWhereInput, $take: Int, $skip: Int) {
  users(where: $where, take: $take, skip: $skip) {
    id
    email
    firstName
    lastName
    roles
  }
  usersCount(where: $where)
}
```

#### School System Queries
```graphql
# Get school system with schools
query getSchoolSystem($id: ID!) {
  schoolSystem(where: { id: $id }) {
    id
    name
    schools {
      id
      name
      address
    }
    settings
  }
}
```

#### Course Queries
```graphql
# Search courses
query searchCourses($search: String!) {
  courses(
    where: {
      OR: [
        { code: { contains: $search, mode: insensitive } }
        { name: { contains: $search, mode: insensitive } }
      ]
    }
  ) {
    id
    code
    name
    description
    prerequisites
  }
}
```

#### Class Queries
```graphql
# Get class with full details
query getClassDetails($id: ID!) {
  class(where: { id: $id }) {
    id
    section
    maxEnrollment
    room
    schedule
    course {
      code
      name
    }
    semester {
      name
      startDate
      endDate
    }
    instructor {
      firstName
      lastName
      email
    }
    teachingAssistants {
      id
      firstName
      lastName
    }
    enrollments {
      id
      status
      student {
        id
        firstName
        lastName
        studentId
      }
    }
    meetings {
      id
      scheduledDate
      status
    }
  }
}

# Get today's classes for instructor
query todaysClasses($instructorId: ID!, $today: DateTime!) {
  classes(
    where: {
      instructor: { id: { equals: $instructorId } }
      meetings: {
        some: {
          scheduledDate: { equals: $today }
          status: { equals: scheduled }
        }
      }
    }
  ) {
    id
    section
    course {
      code
      name
    }
    meetings(
      where: {
        scheduledDate: { equals: $today }
        status: { equals: scheduled }
      }
    ) {
      id
      scheduledStartTime
      scheduledEndTime
      room
    }
  }
}
```

#### Attendance Queries
```graphql
# Get attendance grid data
query getAttendanceGrid($classId: ID!) {
  class(where: { id: $classId }) {
    id
    enrollments(where: { status: { equals: enrolled } }) {
      id
      student {
        id
        firstName
        lastName
        studentId
        qrCode
      }
      attendanceRecords {
        id
        status
        clockInTime
        clockOutTime
        sessionDuration
        classSession {
          id
        }
      }
    }
    sessions(orderBy: { scheduledDate: asc }) {
      id
      scheduledDate
      dayOfWeek
      courseNumber
      sessionType
      scheduledStartTime
      scheduledEndTime
      status
    }
  }
}

# Find student by QR code
query findStudentByQR($qrCode: String!) {
  students(where: { qrCode: { equals: $qrCode } }) {
    id
    firstName
    lastName
    studentId
    enrollments(where: { status: { equals: enrolled } }) {
      id
      class {
        id
        section
        course {
          code
        }
      }
    }
  }
}
```

### Core Mutations

#### User Management
```graphql
# Create user
mutation createUser($data: UserCreateInput!) {
  createUser(data: $data) {
    id
    email
    firstName
    lastName
    roles
  }
}

# Update user roles
mutation updateUserRoles($id: ID!, $roles: [UserRolesType!]) {
  updateUser(
    where: { id: $id }
    data: { roles: { set: $roles } }
  ) {
    id
    roles
  }
}
```

#### Course Management
```graphql
# Create course
mutation createCourse($data: CourseCreateInput!) {
  createCourse(data: $data) {
    id
    code
    name
    description
  }
}
```

#### Class Management
```graphql
# Create class with schedule
mutation createClass($data: ClassCreateInput!) {
  createClass(data: $data) {
    id
    section
    schedule
    meetings {
      id
      scheduledDate
    }
  }
}

# Cancel class meeting
mutation cancelMeeting($id: ID!) {
  updateClassMeeting(
    where: { id: $id }
    data: { status: cancelled }
  ) {
    id
    status
  }
}
```

#### Enrollment Management
```graphql
# Enroll student
mutation enrollStudent($studentId: ID!, $classId: ID!) {
  createEnrollment(
    data: {
      student: { connect: { id: $studentId } }
      class: { connect: { id: $classId } }
      status: enrolled
      enrolledAt: "${new Date().toISOString()}"
    }
  ) {
    id
    status
    waitlistPosition
  }
}

# Drop student
mutation dropStudent($enrollmentId: ID!) {
  updateEnrollment(
    where: { id: $enrollmentId }
    data: {
      status: dropped
      droppedAt: "${new Date().toISOString()}"
    }
  ) {
    id
    status
  }
}

# Promote from waitlist
mutation promoteFromWaitlist($enrollmentId: ID!) {
  updateEnrollment(
    where: { id: $enrollmentId }
    data: {
      status: enrolled
      waitlistPosition: null
      enrolledAt: "${new Date().toISOString()}"
    }
  ) {
    id
    status
  }
}
```

#### Attendance Management
```graphql
# Clock in student (first scan)
mutation clockInStudent(
  $enrollmentId: ID!
  $sessionId: ID!
) {
  createAttendanceRecord(
    data: {
      enrollment: { connect: { id: $enrollmentId } }
      classSession: { connect: { id: $sessionId } }
      status: present
      clockInTime: "${new Date().toISOString()}"
      markedBy: { connect: { id: $currentUserId } }
    }
  ) {
    id
    status
    clockInTime
  }
}

# Clock out student (second scan)
mutation clockOutStudent(
  $enrollmentId: ID!
  $sessionId: ID!
) {
  updateAttendanceRecord(
    where: { 
      enrollment: { id: { equals: $enrollmentId } }
      classSession: { id: { equals: $sessionId } }
    }
    data: {
      clockOutTime: "${new Date().toISOString()}"
    }
  ) {
    id
    clockInTime
    clockOutTime
    sessionDuration
  }
}

# Manual update attendance (for teachers/TAs)
mutation updateAttendanceManual(
  $enrollmentId: ID!
  $sessionId: ID!
  $data: AttendanceRecordUpdateInput!
) {
  updateAttendanceRecord(
    where: { 
      enrollment: { id: { equals: $enrollmentId } }
      classSession: { id: { equals: $sessionId } }
    }
    data: $data
  ) {
    id
    status
    clockInTime
    clockOutTime
    sessionDuration
  }
}

# Bulk mark attendance
mutation bulkMarkAttendance($records: [AttendanceRecordCreateInput!]!) {
  createAttendanceRecords(data: $records) {
    id
    status
  }
}
```

### Subscriptions

```graphql
# Real-time attendance updates
subscription attendanceUpdates($classId: ID!) {
  attendanceRecordUpdated(where: { 
    enrollment: { 
      class: { 
        id: { equals: $classId } 
      } 
    } 
  }) {
    id
    status
    enrollment {
      student {
        firstName
        lastName
      }
    }
  }
}
```

## Custom REST Endpoints

### Export Endpoints

#### Export Attendance CSV
```http
GET /api/export/attendance/:classId
Authorization: Bearer <session-token>

Response: CSV file
"Student Name","Student ID","09/01","09/03","09/05",...
"John Doe","12345","Present","Absent","Excused",...
```

#### Export Class Roster
```http
GET /api/export/roster/:classId
Authorization: Bearer <session-token>

Response: CSV file
"First Name","Last Name","Student ID","Email","Status"
"John","Doe","12345","john@example.com","Enrolled"
```

### Bulk Operations

#### Bulk Import Students
```http
POST /api/import/students
Authorization: Bearer <session-token>
Content-Type: multipart/form-data

Body: CSV file with headers:
firstName,lastName,studentId,email

Response:
{
  "imported": 45,
  "errors": [
    {
      "row": 12,
      "error": "Duplicate student ID"
    }
  ]
}
```

### QR Code Generation

#### Generate QR Code Image
```http
GET /api/qr/:studentId
Authorization: Bearer <session-token>

Response: PNG image of QR code
```

#### Regenerate QR Code
```http
POST /api/qr/:studentId/regenerate
Authorization: Bearer <session-token>

Response:
{
  "studentId": "12345",
  "newQrCode": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Health & Status

#### Health Check
```http
GET /health

Response:
{
  "status": "healthy",
  "timestamp": "2025-07-03T10:00:00Z",
  "services": {
    "database": "connected",
    "redis": "connected"
  }
}
```

#### System Info
```http
GET /api/system/info
Authorization: Bearer <session-token>

Response:
{
  "version": "1.0.0",
  "environment": "production",
  "schoolSystemId": "abc123",
  "stats": {
    "totalStudents": 1234,
    "totalClasses": 45,
    "activeSemester": "Fall 2025"
  }
}
```

## Error Responses

### Standard Error Format
```json
{
  "error": {
    "message": "Human-readable error message",
    "code": "ERROR_CODE",
    "details": {
      "field": "Additional context"
    }
  }
}
```

### Common Error Codes
- `UNAUTHENTICATED` - No valid session
- `FORBIDDEN` - Insufficient permissions
- `NOT_FOUND` - Resource doesn't exist
- `VALIDATION_ERROR` - Input validation failed
- `CONFLICT` - Duplicate or conflicting data
- `CAPACITY_EXCEEDED` - Class is full
- `INVALID_QR_CODE` - QR code not found

## Rate Limiting

### Limits by Role
- Super Admin: 1000 requests/minute
- Admin: 500 requests/minute
- Instructor: 200 requests/minute
- TA: 100 requests/minute

### Headers
```http
X-RateLimit-Limit: 200
X-RateLimit-Remaining: 150
X-RateLimit-Reset: 1625320800
```

## Webhooks

### Enrollment Webhook
```http
POST https://your-endpoint.com/webhooks/enrollment
Content-Type: application/json
X-Webhook-Signature: sha256=<signature>

{
  "event": "enrollment.created",
  "timestamp": "2025-07-03T10:00:00Z",
  "data": {
    "enrollmentId": "123",
    "studentId": "456",
    "classId": "789",
    "status": "enrolled"
  }
}
```

### Available Events
- `enrollment.created`
- `enrollment.dropped`
- `enrollment.waitlisted`
- `attendance.marked`
- `meeting.cancelled`
- `class.updated`

## SDK Examples

### JavaScript/TypeScript
```typescript
import { GraphQLClient } from 'graphql-request';

const client = new GraphQLClient('https://your-domain.com/api/graphql', {
  credentials: 'include',
});

// Mark attendance
async function markAttendance(qrCode: string, meetingId: string) {
  const student = await client.request(findStudentByQR, { qrCode });
  
  if (!student.students.length) {
    throw new Error('Invalid QR code');
  }
  
  const enrollment = student.students[0].enrollments.find(
    e => e.class.meetings.some(m => m.id === meetingId)
  );
  
  if (!enrollment) {
    throw new Error('Student not enrolled in this class');
  }
  
  return client.request(markAttendanceMutation, {
    enrollmentId: enrollment.id,
    meetingId,
    status: 'present'
  });
}
```

### Python
```python
import requests
from datetime import datetime

class TorqueEdClient:
    def __init__(self, base_url, session_token):
        self.base_url = base_url
        self.headers = {
            'Authorization': f'Bearer {session_token}',
            'Content-Type': 'application/json'
        }
    
    def get_attendance_grid(self, class_id):
        query = """
          query($classId: ID!) {
            class(where: { id: $classId }) {
              enrollments { ... }
              meetings { ... }
            }
          }
        """
        
        response = requests.post(
            f"{self.base_url}/api/graphql",
            json={'query': query, 'variables': {'classId': class_id}},
            headers=self.headers
        )
        
        return response.json()
```

## Best Practices

1. **Pagination**: Always paginate large lists
2. **Field Selection**: Only request needed fields
3. **Caching**: Use ETags for REST endpoints
4. **Error Handling**: Always handle network and GraphQL errors
5. **Optimistic Updates**: Update UI before server confirmation
6. **Batch Operations**: Use bulk mutations when available